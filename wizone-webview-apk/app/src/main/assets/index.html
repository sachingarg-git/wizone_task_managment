<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Wizone IT Support - Mobile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #2c5aa0, #1e3d72);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .header .subtitle {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .status-bar {
            padding: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .status-offline {
            background: #ff6b6b;
            color: white;
        }
        
        .status-online {
            background: #51cf66;
            color: white;
        }
        
        .status-connecting {
            background: #feca57;
            color: #333;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .login-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .input-group {
            position: relative;
        }
        
        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #2c5aa0;
            background: white;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }
        
        .login-btn {
            background: linear-gradient(135deg, #2c5aa0, #1e3d72);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(44, 90, 160, 0.3);
        }
        
        .login-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 10px rgba(44, 90, 160, 0.3);
        }
        
        .user-info {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2c5aa0;
        }
        
        .user-info h3 {
            color: #2c5aa0;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .user-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 13px;
        }
        
        .user-detail {
            background: white;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }
        
        .user-detail .label {
            font-weight: bold;
            color: #666;
            font-size: 11px;
            text-transform: uppercase;
        }
        
        .user-detail .value {
            color: #333;
            margin-top: 2px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-top: 3px solid #2c5aa0;
        }
        
        .stat-card .number {
            font-size: 24px;
            font-weight: bold;
            color: #2c5aa0;
        }
        
        .stat-card .label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .action-btn {
            background: white;
            border: 2px solid #2c5aa0;
            color: #2c5aa0;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .action-btn:active {
            background: #2c5aa0;
            color: white;
        }
        
        .tasks-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tasks-header {
            background: #2c5aa0;
            color: white;
            padding: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .task-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.3s ease;
        }
        
        .task-item:last-child {
            border-bottom: none;
        }
        
        .task-item.pending {
            border-left: 4px solid #feca57;
        }
        
        .task-item.in-progress {
            border-left: 4px solid #3742fa;
        }
        
        .task-item.completed {
            border-left: 4px solid #2ed573;
        }
        
        .task-item.cancelled {
            border-left: 4px solid #ff6b6b;
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .task-id {
            font-weight: bold;
            color: #2c5aa0;
            font-size: 14px;
        }
        
        .task-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-pending { background: #feca57; color: #333; }
        .status-in-progress { background: #3742fa; color: white; }
        .status-completed { background: #2ed573; color: white; }
        .status-cancelled { background: #ff6b6b; color: white; }
        
        .task-details {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .task-customer {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .task-actions {
            display: flex;
            gap: 8px;
        }
        
        .task-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-start {
            background: #3742fa;
            color: white;
        }
        
        .btn-complete {
            background: #2ed573;
            color: white;
        }
        
        .btn-cancel {
            background: #ff6b6b;
            color: white;
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .alert-error {
            background: #ffe6e6;
            color: #d63031;
            border: 1px solid #ff6b6b;
        }
        
        .alert-success {
            background: #e6f7e6;
            color: #00b894;
            border: 1px solid #2ed573;
        }
        
        .alert-info {
            background: #e6f3ff;
            color: #0984e3;
            border: 1px solid #74b9ff;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #666;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e1e8ed;
            border-top: 2px solid #2c5aa0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .refresh-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #2c5aa0;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .refresh-indicator.show {
            opacity: 1;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .user-details {
                grid-template-columns: 1fr;
            }
            
            .task-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîß Wizone IT Support</h1>
            <div class="subtitle">Mobile Engineer Portal</div>
        </div>
        
        <!-- Status Bar -->
        <div id="status-bar" class="status-bar status-connecting">
            üîÑ Connecting to server...
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Login Section -->
            <div id="login-section" class="login-section">
                <div class="login-form">
                    <div class="input-group">
                        <input type="text" id="username" placeholder="üë§ Enter Username" autocomplete="username" style="width: 100%; padding: 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 16px; background: #f8f9fa;">
                    </div>
                    <div class="input-group">
                        <input type="password" id="password" placeholder="üîí Enter Password" autocomplete="current-password" style="width: 100%; padding: 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 16px; background: #f8f9fa;">
                    </div>
                    <button class="login-btn" onclick="performLogin()">
                        üöÄ Connect to Dashboard
                    </button>
                </div>
                <div id="login-status"></div>
            </div>
            
            <!-- Main App -->
            <div id="main-app" style="display:none;">
                <!-- User Info -->
                <div id="user-info" class="user-info"></div>
                
                <!-- Stats -->
                <div id="stats-grid" class="stats-grid"></div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="action-btn" onclick="refreshTasks()">
                        üîÑ Refresh Tasks
                    </button>
                    <button class="action-btn" onclick="loadTaskHistory()">
                        üìà View History
                    </button>
                </div>
                
                <!-- Tasks Container -->
                <div class="tasks-container">
                    <div class="tasks-header">
                        <span>üìã My Active Tasks</span>
                        <span id="tasks-count">0</span>
                    </div>
                    <div id="tasks-list"></div>
                </div>
            </div>
        </div>
        
        <!-- Refresh Indicator -->
        <div id="refresh-indicator" class="refresh-indicator">
            Syncing with server...
        </div>
    </div>

    <script>
        // Production Configuration
        const API_BASE_URL = 'http://103.122.85.61:3001';
        
        // Global State
        let currentUser = null;
        let userTasks = [];
        let autoRefreshInterval = null;
        let lastUpdateTime = null;
        
        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Wizone IT Support Mobile App Initialized');
            checkServerConnection();
            
            // Auto-retry connection every 30 seconds if offline
            setInterval(checkServerConnection, 30000);
        });
        
        // Server Connection Check
        async function checkServerConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'Wizone-Mobile-App/2.0'
                    },
                    timeout: 10000
                });
                
                if (response.ok) {
                    updateStatusBar('üü¢ Server Online - Ready to Connect', 'online');
                    
                    // Auto-login if credentials stored
                    const savedUsername = localStorage.getItem('wizone_username');
                    const savedPassword = localStorage.getItem('wizone_password');
                    
                    if (savedUsername && savedPassword && !currentUser) {
                        document.getElementById('username').value = savedUsername;
                        document.getElementById('password').value = savedPassword;
                        setTimeout(performLogin, 1000);
                    }
                } else {
                    throw new Error('Server not responding');
                }
            } catch (error) {
                updateStatusBar('üî¥ Server Offline - Retrying...', 'offline');
                console.error('Connection check failed:', error);
            }
        }
        
        // Update Status Bar
        function updateStatusBar(message, status) {
            const statusBar = document.getElementById('status-bar');
            statusBar.textContent = message;
            statusBar.className = `status-bar status-${status}`;
        }
        
        // Login Function
        async function performLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const statusDiv = document.getElementById('login-status');
            
            if (!username || !password) {
                showAlert('Please enter both username and password', 'error', statusDiv);
                return;
            }
            
            updateStatusBar('üîê Connecting to 103.122.85.61...', 'connecting');
            
            try {
                console.log(`üîê Attempting login for: ${username}`);
                
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'Wizone-Mobile-App/2.0',
                        'X-Mobile-App': 'true'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    currentUser = userData.user || userData;
                    
                    console.log(`‚úÖ Login successful for: ${currentUser.username} (ID: ${currentUser.id})`);
                    
                    // Store credentials
                    localStorage.setItem('wizone_username', username);
                    localStorage.setItem('wizone_password', password);
                    
                    updateStatusBar(`üü¢ Connected - Welcome ${currentUser.username}!`, 'online');
                    showAlert(`‚úÖ Successfully connected to database!`, 'success', statusDiv);
                    showLoginSuccess();
                    await initializeDashboard();
                    
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Authentication failed (${response.status})`);
                }
                
            } catch (error) {
                console.error('Login error:', error);
                updateStatusBar('üî¥ Connection Failed', 'offline');
                showAlert(`Connection failed: ${error.message}`, 'error', statusDiv);
            }
        }
        
        // Show Login Success
        function showLoginSuccess() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
        }
        
        // Initialize Dashboard
        async function initializeDashboard() {
            displayUserInfo();
            await loadUserTasks();
            startAutoRefresh();
        }
        
        // Display User Information
        function displayUserInfo() {
            const userInfoDiv = document.getElementById('user-info');
            userInfoDiv.innerHTML = `
                <h3>üë®‚Äçüíº Engineer Details</h3>
                <div class="user-details">
                    <div class="user-detail">
                        <div class="label">Username</div>
                        <div class="value">${currentUser.username}</div>
                    </div>
                    <div class="user-detail">
                        <div class="label">ID</div>
                        <div class="value">#${currentUser.id}</div>
                    </div>
                    <div class="user-detail">
                        <div class="label">Role</div>
                        <div class="value">${currentUser.role || 'Engineer'}</div>
                    </div>
                    <div class="user-detail">
                        <div class="label">Status</div>
                        <div class="value">üü¢ Online</div>
                    </div>
                </div>
            `;
        }
        
        // Load User Tasks - Only tasks assigned to current engineer
        async function loadUserTasks() {
            try {
                showRefreshIndicator();
                
                const response = await authenticatedRequest(`${API_BASE_URL}/api/tasks`, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const allTasks = await response.json();
                    
                    console.log(`üìä Total tasks in database: ${allTasks.length}`);
                    console.log(`üë§ Current engineer - ID: ${currentUser.id}, Username: ${currentUser.username}`);
                    
                    // Filter tasks STRICTLY for current engineer only
                    userTasks = allTasks.filter(task => {
                        // Check if task is assigned to current engineer
                        const isMyTask = (
                            task.fieldEngineerId === currentUser.id ||
                            task.assignedTo === currentUser.id ||
                            (task.fieldEngineerName && task.fieldEngineerName.toLowerCase() === currentUser.username.toLowerCase()) ||
                            (task.assignedToName && task.assignedToName.toLowerCase() === currentUser.username.toLowerCase())
                        );
                        
                        if (isMyTask) {
                            console.log(`‚úÖ Task #${task.id} - Assigned to ${currentUser.username}`);
                        }
                        
                        return isMyTask;
                    });
                    
                    console.log(`üìã My assigned tasks: ${userTasks.length}`);
                    
                    // Only admins can see all tasks if they have no assigned tasks
                    if (userTasks.length === 0 && currentUser.username === 'admin') {
                        console.log('üë®‚Äçüíº Admin user - showing all tasks for management');
                        userTasks = allTasks;
                    }
                    
                    displayUserStats();
                    displayTasks();
                    lastUpdateTime = new Date();
                    
                } else {
                    throw new Error(`Failed to load tasks: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                showAlert('Failed to load tasks from database', 'error');
            } finally {
                hideRefreshIndicator();
            }
        }
        
        // Display User Statistics
        function displayUserStats() {
            const statsGrid = document.getElementById('stats-grid');
            
            const pending = userTasks.filter(t => t.status === 'pending').length;
            const inProgress = userTasks.filter(t => t.status === 'in-progress').length;
            const completed = userTasks.filter(t => t.status === 'completed').length;
            const total = userTasks.length;
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="number">${total}</div>
                    <div class="label">Total Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="number">${pending}</div>
                    <div class="label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="number">${inProgress}</div>
                    <div class="label">In Progress</div>
                </div>
                <div class="stat-card">
                    <div class="number">${completed}</div>
                    <div class="label">Completed</div>
                </div>
            `;
        }
        
        // Display Tasks with full details like task management
        function displayTasks() {
            const tasksList = document.getElementById('tasks-list');
            const tasksCount = document.getElementById('tasks-count');
            
            tasksCount.textContent = userTasks.length;
            
            if (userTasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No Tasks Assigned</h3>
                        <p>You don't have any tasks assigned to you.</p>
                    </div>
                `;
                return;
            }
            
            tasksList.innerHTML = userTasks.map(task => `
                <div class="task-item ${task.status}">
                    <div class="task-header">
                        <div class="task-id">Task #${task.id}</div>
                        <div class="task-status status-${task.status}">
                            ${task.status.toUpperCase()}
                        </div>
                    </div>
                    
                    <div class="task-customer">
                        üë§ Customer: ${task.customerName || task.customer_name || 'Not Assigned'}
                    </div>
                    
                    <div class="task-details">
                        üìù <strong>Title:</strong> ${task.title || 'No Title'}
                    </div>
                    
                    <div class="task-details">
                        üìÑ <strong>Description:</strong> ${task.description || 'No Description'}
                    </div>
                    
                    <div class="task-details">
                        ÔøΩ <strong>Ticket:</strong> ${task.ticketNumber || 'No Ticket'} | 
                        ‚ö° <strong>Priority:</strong> ${task.priority || 'Normal'}
                    </div>
                    
                    <div class="task-details">
                        üè∑Ô∏è <strong>Category:</strong> ${task.category || 'General'} | 
                        ‚è∞ <strong>Est. Hours:</strong> ${task.estimatedHours || 'Not Set'}
                    </div>
                    
                    <div class="task-details">
                        üìÖ <strong>Created:</strong> ${new Date(task.createdAt || task.created_at).toLocaleDateString()}
                        ${task.dueDate ? ` | üóìÔ∏è <strong>Due:</strong> ${new Date(task.dueDate).toLocaleDateString()}` : ''}
                    </div>
                    
                    <div class="task-details">
                        üë∑ <strong>Assigned to:</strong> ${task.fieldEngineerName || task.assignedToName || currentUser.username}
                    </div>
                    
                    <div class="task-actions">
                        <select onchange="updateTaskStatus(${task.id}, this.value)" style="flex: 1; padding: 8px; border-radius: 6px; font-size: 12px; font-weight: bold; margin-right: 5px; background: white; border: 2px solid #2c5aa0;">
                            <option value="">üîÑ Change Status</option>
                            <option value="pending" ${task.status === 'pending' ? 'disabled' : ''}>üìã Pending</option>
                            <option value="in-progress" ${task.status === 'in-progress' ? 'disabled' : ''}>‚ñ∂Ô∏è In Progress</option>
                            <option value="completed" ${task.status === 'completed' ? 'disabled' : ''}>‚úÖ Completed</option>
                            <option value="cancelled" ${task.status === 'cancelled' ? 'disabled' : ''}>‚ùå Cancelled</option>
                            <option value="on-hold">‚è∏Ô∏è On Hold</option>
                        </select>
                        
                        <button class="task-btn" onclick="viewTaskDetails(${task.id})" style="background: #6c757d; flex: 0.5;">
                            ÔøΩÔ∏è Details
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Update Task Status - Same as task management system
        async function updateTaskStatus(taskId, newStatus) {
            if (!newStatus) return; // User selected "Change Status" option
            
            try {
                showRefreshIndicator();
                
                console.log(`üîÑ Updating Task #${taskId} to status: ${newStatus}`);
                
                const updateData = {
                    status: newStatus,
                    updated_at: new Date().toISOString(),
                    updated_by: currentUser.username,
                    updated_by_id: currentUser.id
                };
                
                const response = await authenticatedRequest(`${API_BASE_URL}/api/tasks/${taskId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    const updatedTask = await response.json();
                    showAlert(`‚úÖ Task #${taskId} updated to "${newStatus.toUpperCase()}"`, 'success');
                    
                    // Update local task data
                    const taskIndex = userTasks.findIndex(t => t.id === taskId);
                    if (taskIndex !== -1) {
                        userTasks[taskIndex].status = newStatus;
                        userTasks[taskIndex].updated_at = new Date().toISOString();
                    }
                    
                    // Refresh display
                    displayUserStats();
                    displayTasks();
                    
                    console.log(`‚úÖ Task ${taskId} successfully updated to ${newStatus}`);
                    
                } else {
                    throw new Error(`Update failed: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Error updating task:', error);
                showAlert(`‚ùå Failed to update task: ${error.message}`, 'error');
            } finally {
                hideRefreshIndicator();
            }
        }
        
        // View Task Details
        function viewTaskDetails(taskId) {
            const task = userTasks.find(t => t.id === taskId);
            if (!task) return;
            
            const detailsHtml = `
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 10px 0;">
                    <h3 style="color: #2c5aa0; margin-bottom: 15px;">üìã Task #${task.id} Details</h3>
                    
                    <div style="margin-bottom: 10px;"><strong>Title:</strong> ${task.title || 'Not Set'}</div>
                    <div style="margin-bottom: 10px;"><strong>Description:</strong> ${task.description || 'Not Set'}</div>
                    <div style="margin-bottom: 10px;"><strong>Customer:</strong> ${task.customerName || 'Not Set'}</div>
                    <div style="margin-bottom: 10px;"><strong>Status:</strong> ${task.status.toUpperCase()}</div>
                    <div style="margin-bottom: 10px;"><strong>Priority:</strong> ${task.priority || 'Normal'}</div>
                    <div style="margin-bottom: 10px;"><strong>Category:</strong> ${task.category || 'General'}</div>
                    <div style="margin-bottom: 10px;"><strong>Ticket Number:</strong> ${task.ticketNumber || 'Not Set'}</div>
                    <div style="margin-bottom: 10px;"><strong>Estimated Hours:</strong> ${task.estimatedHours || 'Not Set'}</div>
                    <div style="margin-bottom: 10px;"><strong>Actual Hours:</strong> ${task.actualHours || '0'}</div>
                    <div style="margin-bottom: 10px;"><strong>Created:</strong> ${new Date(task.createdAt).toLocaleString()}</div>
                    <div style="margin-bottom: 10px;"><strong>Updated:</strong> ${new Date(task.updatedAt).toLocaleString()}</div>
                    <div style="margin-bottom: 10px;"><strong>Assigned Engineer:</strong> ${task.fieldEngineerName || currentUser.username}</div>
                    
                    <button onclick="this.parentElement.style.display='none'" style="width: 100%; padding: 10px; background: #2c5aa0; color: white; border: none; border-radius: 5px; margin-top: 15px;">
                        Close Details
                    </button>
                </div>
            `;
            
            const tasksContainer = document.getElementById('tasks-list');
            tasksContainer.insertAdjacentHTML('afterbegin', detailsHtml);
        }
        
        // Authenticated Request Helper
        async function authenticatedRequest(url, options = {}) {
            const defaultHeaders = {
                'Content-Type': 'application/json',
                'User-Agent': 'Wizone-Mobile-App/2.0',
                'X-Mobile-App': 'true'
            };
            
            return fetch(url, {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                },
                credentials: 'include'
            });
        }
        
        // Refresh Tasks
        async function refreshTasks() {
            await loadUserTasks();
            showAlert('Tasks refreshed successfully', 'success');
        }
        
        // Start Auto Refresh
        function startAutoRefresh() {
            // Refresh every 30 seconds
            autoRefreshInterval = setInterval(async () => {
                console.log('üîÑ Auto-refreshing tasks...');
                await loadUserTasks();
            }, 30000);
        }
        
        // Show Alert
        function showAlert(message, type, container = null) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            if (container) {
                container.innerHTML = '';
                container.appendChild(alertDiv);
            } else {
                document.querySelector('.main-content').insertBefore(
                    alertDiv, 
                    document.querySelector('.main-content').firstChild
                );
            }
            
            // Auto-remove alert after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }
        
        // Show/Hide Refresh Indicator
        function showRefreshIndicator() {
            document.getElementById('refresh-indicator').classList.add('show');
        }
        
        function hideRefreshIndicator() {
            document.getElementById('refresh-indicator').classList.remove('show');
        }
        
        // Load Task History
        async function loadTaskHistory() {
            try {
                const response = await authenticatedRequest(`${API_BASE_URL}/api/tasks/history`, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const history = await response.json();
                    showTaskHistory(history);
                } else {
                    showAlert('Failed to load task history', 'error');
                }
            } catch (error) {
                console.error('Error loading history:', error);
                showAlert('Failed to load task history', 'error');
            }
        }
        
        // View Task History
        function viewTaskHistory(taskId) {
            showAlert(`Loading history for Task #${taskId}...`, 'info');
            // Implementation for individual task history
        }
        
        // Show Task History
        function showTaskHistory(history) {
            showAlert(`Loaded ${history.length} historical records`, 'info');
            // Implementation for displaying history
        }
        
        console.log('üì± Wizone IT Support Mobile App Ready');
    </script>
</body>
</html>