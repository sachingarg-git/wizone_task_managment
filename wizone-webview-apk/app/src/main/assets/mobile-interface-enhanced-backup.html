<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Wizone Task Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            padding: 16px 20px 20px 20px;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.3);
        }
        
        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .header-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
        }
        
        .user-info h1 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            line-height: 1.2;
        }
        
        .user-info p {
            font-size: 13px;
            opacity: 0.9;
            margin: 0;
            line-height: 1.3;
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
        }
        
        .header-btn {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 8px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .welcome-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 16px;
            margin-top: 8px;
        }
        
        .welcome-text {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .welcome-subtext {
            font-size: 13px;
            opacity: 0.8;
        }
        
        .main-content {
            flex: 1;
            padding: 16px;
            padding-bottom: 80px; /* Space for navigation */
            background: #f8fafc;
        }
        
        .auth-container {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: white;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
            margin: 5px;
        }
        
        .dashboard {
            display: none;
        }
        
        .dashboard.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: white;
            padding: 20px 16px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        
        .stat-card.blue {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: #93c5fd;
        }
        
        .stat-card.yellow {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #fbbf24;
        }
        
        .stat-card.indigo {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border-color: #818cf8;
        }
        
        .stat-card.green {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #34d399;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        .stat-icon {
            width: 32px;
            height: 32px;
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .stat-icon.blue { background: #3b82f6; color: white; }
        .stat-icon.yellow { background: #f59e0b; color: white; }
        .stat-icon.indigo { background: #6366f1; color: white; }
        .stat-icon.green { background: #10b981; color: white; }
        
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            line-height: 1;
        }
        
        .stat-number.blue { color: #1d4ed8; }
        .stat-number.yellow { color: #d97706; }
        .stat-number.indigo { color: #4f46e5; }
        .stat-number.green { color: #059669; }
        
        .stat-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            line-height: 1.2;
        }
        
        .tasks-section {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
        }
        
        .section-title {
            color: #1e293b;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .section-title-main {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-icon {
            margin-right: 8px;
            font-size: 24px;
        }
        
        .refresh-btn {
            margin-left: auto !important;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1)) !important;
            border: 1px solid rgba(255,255,255,0.3) !important;
            border-radius: 50% !important;
            width: 36px !important;
            height: 36px !important;
            font-size: 16px !important;
            cursor: pointer !important;
            color: #ffffff !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.3s ease !important;
        }
        
        .refresh-btn:hover {
            background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.2)) !important;
            transform: rotate(180deg) !important;
        }
        
        .task-count {
            background: #e2e8f0;
            color: #64748b;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .task-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #3b82f6;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            border-left-color: #1d4ed8;
        }
        
        .task-card:last-child {
            margin-bottom: 0;
        }
        
        .task-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .task-id {
            color: #3b82f6;
            font-weight: 600;
            font-size: 14px;
            text-decoration: none;
        }
        
        .task-id:hover {
            text-decoration: underline;
        }
        
        .task-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
        }
        
        .status-in-progress {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }
        
        .status-completed {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        
        .task-title {
            color: #1e293b;
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        
        .task-meta {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .task-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #64748b;
        }
        
        .task-meta-icon {
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .task-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f1f5f9;
        }
        
        .task-priority {
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .priority-high {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }
        
        .priority-medium {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fbbf24;
        }
        
        .priority-low {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #4ade80;
        }
        
        .task-date {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .task-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .task-id {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .task-status {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-in-progress, .status-in_progress {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-open {
            background: #e2e3e5;
            color: #495057;
        }
        
        .task-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .task-description {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 10px;
            border-top: 1px solid #e1e5e9;
            display: none;
        }
        
        .navigation.active {
            display: block;
        }
        
        .nav-buttons {
            display: flex;
            justify-content: space-around;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .nav-btn {
            background: none;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-btn.active {
            background: #667eea;
            color: white;
        }
        
        .offline-banner {
            background: #ff6b6b;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 12px;
            display: none;
        }
        
        .offline-banner.show {
            display: block;
        }
        
        .profile-section {
            display: none;
        }
        
        .profile-section.active {
            display: block;
        }
        
        .profile-info {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: 700;
            margin: 0 auto 15px;
        }
        
        .profile-name {
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .profile-email {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
        }

        /* Task Detail Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
        }

        .modal-title {
            color: #2c5aa0;
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section h4 {
            color: #2c5aa0;
            font-size: 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-grid {
            display: grid;
            gap: 10px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .detail-label {
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .detail-value {
            color: #666;
            flex: 2;
            text-align: right;
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .history-type {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .history-date {
            color: #888;
            font-size: 12px;
        }

        .history-note {
            color: #333;
            font-size: 14px;
            line-height: 1.4;
        }

        .status-update-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .user-management-section {
            display: none;
        }

        .user-management-section.active {
            display: block;
        }

        .user-list {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .user-card {
            background: white;
            border: 2px solid #f1f3f4;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .user-card:hover {
            border-color: #667eea;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .user-name {
            font-weight: 600;
            color: #333;
        }

        .user-role {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .user-info {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="offline-banner" id="offlineBanner">
            üìµ Working in offline mode - Some features may be limited
        </div>
        
        <div class="header">
            <div class="header-top">
                <div class="header-user">
                    <div class="user-avatar" id="userAvatar">W</div>
                    <div class="user-info">
                        <h1 id="headerTitle">Wizone Task Manager</h1>
                        <p id="headerSubtitle">Professional Engineering Support</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="refreshTasks()" title="Sync Tasks">
                        üîÑ
                    </button>
                    <button class="header-btn" onclick="showProfile()" title="Profile">
                        üë§
                    </button>
                </div>
            </div>
            <div class="welcome-card" id="welcomeCard" style="display: none;">
                <div class="welcome-text" id="welcomeText">Welcome back!</div>
                <div class="welcome-subtext" id="welcomeSubtext">Manage your tasks efficiently</div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Login Section -->
            <div class="auth-container" id="loginSection">
                <h3 style="color: #2c5aa0; margin-bottom: 20px; text-align: center;">üë§ Engineer Login</h3>
                <div style="background: #4caf50; color: white; padding: 8px; border-radius: 5px; margin: 10px 0; font-size: 12px; text-align: center;">
                    ‚úÖ INSTANT LOGIN - No Server Required<br>
                    üë§ Admin: admin/admin123<br>
                    üîß Field Engineers: ravi/ravi@123<br>
                    üì± Fast & Reliable APK Mode
                </div>
                
                <div id="errorMessage" class="error-message" style="display: none;"></div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" placeholder="Enter your username" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" placeholder="Enter your password" required>
                    </div>
                    
                    <button type="submit" class="btn" id="loginBtn">
                        üîë Login to Dashboard
                    </button>
                    
                    <button type="button" class="btn btn-secondary" onclick="showOfflineMode()">
                        üì± Continue Offline
                    </button>
                </form>
                
                <!-- Security: Credentials removed for production -->
            </div>
            
            <!-- Dashboard Section -->
            <div class="dashboard" id="dashboardSection">
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card blue">
                        <div class="stat-icon blue">üìã</div>
                        <div class="stat-number blue" id="totalTasks">3</div>
                        <div class="stat-label">My Tasks</div>
                    </div>
                    <div class="stat-card yellow">
                        <div class="stat-icon yellow">‚è∞</div>
                        <div class="stat-number yellow" id="pendingTasks">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-card indigo">
                        <div class="stat-icon indigo">‚ö°</div>
                        <div class="stat-number indigo" id="inProgressTasks">0</div>
                        <div class="stat-label">In Progress</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-icon green">‚úÖ</div>
                        <div class="stat-number green" id="completedTasks">1</div>
                        <div class="stat-label">Completed</div>
                    </div>
                </div>
                
                <div class="tasks-section">
                    <div class="section-title">
                        <span class="section-icon">üéØ</span>
                        <span>Active Tasks</span>
                        <button class="refresh-btn" onclick="refreshTasks()">üîÑ</button>
                    </div>
                    
                    <div id="loadingTasks" class="loading">
                        <div class="spinner"></div>
                        <div>Loading tasks...</div>
                    </div>
                    
                    <div id="tasksContainer"></div>
                </div>
            </div>
            
            <!-- User Management Section -->
            <div class="user-management-section" id="userManagementSection">
                <div class="user-list">
                    <div class="section-title">
                        <span class="section-icon">üë•</span>
                        <span>User Management</span>
                        <button class="refresh-btn" onclick="refreshUsers()">üîÑ</button>
                    </div>
                    
                    <div id="loadingUsers" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <div>Loading users...</div>
                    </div>
                    
                    <div id="usersContainer"></div>
                </div>
            </div>
            
            <!-- Profile Section -->
            <div class="profile-section" id="profileSection">
                <div class="profile-info">
                    <div class="profile-avatar" id="profileAvatar">A</div>
                    <div class="profile-name" id="profileName">Admin User</div>
                    <div class="profile-email" id="profileEmail">admin@wizone.com</div>
                    
                    <button class="btn" onclick="logout()">
                        üö™ Logout
                    </button>
                </div>
                
                <div class="tasks-section">
                    <div class="section-title">‚öôÔ∏è Settings</div>
                    <p style="color: #666; padding: 20px; text-align: center;">Settings and preferences will be available in the next update.</p>
                </div>
            </div>
        </div>
        
        <!-- Task Detail Modal -->
        <div class="modal" id="taskModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="modalTitle">Task Details</div>
                    <button class="close-btn" onclick="closeTaskModal()">&times;</button>
                </div>
                
                <div id="modalContent">
                    <!-- Task details will be loaded here -->
                </div>
            </div>
        </div>
        
        <div class="navigation" id="navigation">
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showDashboard()">üè† Dashboard</button>
                <button class="nav-btn" onclick="showUserManagement()">üë• Users</button>
                <button class="nav-btn" onclick="showProfile()">üë§ Profile</button>
            </div>
        </div>
    </div>

    <script>
        // PRODUCTION DATABASE ONLY - No Fallback Mode
        const API_URLS = [
            'http://103.122.85.61:3001'       // ONLY Production Server - No Fallbacks
        ];
        let currentApiUrl = API_URLS[0];
        
        // STRICT DATABASE MODE - Real authentication only
        const TEST_MODE = false;
        const FORCE_OFFLINE = false;
        const USE_REAL_DATABASE = true;
        const REQUIRE_DATABASE_AUTH = true;
        
        // Show final test mode indicator
        console.log('üéØ FINAL TEST MODE - Complete offline functionality');
        let apiUrlIndex = 0;
        let currentUser = null;
        let isOnline = navigator.onLine;
        let offlineMode = false;
        let allTasks = [];
        let allUsers = [];
        let userTasks = []; // Tasks assigned to current user
        
        // Helper function to find working API server
        async function findWorkingApiServer() {
            for (let i = 0; i < API_URLS.length; i++) {
                try {
                    console.log(`Testing API server ${i + 1}: ${API_URLS[i]}`);
                    const response = await fetch(`${API_URLS[i]}/health`, { timeout: 3000 });
                    if (response.ok) {
                        currentApiUrl = API_URLS[i];
                        apiUrlIndex = i;
                        console.log(`‚úÖ Using API server: ${currentApiUrl}`);
                        return true;
                    }
                } catch (error) {
                    console.log(`‚ùå Server ${i + 1} not available:`, error.message);
                }
            }
            console.log('‚ùå No API servers available');
            return false;
        }
        
        // Enhanced mock data for offline mode
        const mockTasks = [
            {
                id: 1,
                title: 'System Maintenance',
                description: 'Perform routine system maintenance and updates for server infrastructure',
                status: 'pending',
                priority: 'high',
                customerId: 2,
                customerName: 'Wizone IT Network India Pvt Ltd',
                customerEmail: 'support@wizoneit.com',
                customerPhone: '+91-9876543210',
                customerAddress: 'IT Park, Sector 45, Gurgaon, Haryana, India',
                assigneeId: 1, // Ravi Kumar
                assigneeName: 'Ravi Kumar',
                issueType: 'maintenance',
                createdAt: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                updatedAt: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString()
            },
            {
                id: 2,
                title: 'Network Configuration',
                description: 'Setup new network infrastructure for client office',
                status: 'in-progress',
                priority: 'medium',
                customerId: 3,
                customerName: 'Tech Solutions Mumbai',
                customerEmail: 'admin@techsolutions.com',
                customerPhone: '+91-9876543211',
                customerAddress: 'Tech Hub, Andheri East, Mumbai, Maharashtra, India',
                assigneeId: 2, // Hussaifa Ali
                assigneeName: 'Hussaifa Ali',
                issueType: 'network',
                createdAt: new Date(Date.now() - 4 * 60 * 60 * 1000).toISOString(),
                updatedAt: new Date(Date.now() - 30 * 60 * 1000).toISOString()
            },
            {
                id: 3,
                title: 'Technical Support Request',
                description: 'Customer needs assistance with system configuration and setup',
                status: 'open',
                priority: 'medium',
                customerId: 2,
                customerName: 'Wizone IT Network India Pvt Ltd',
                customerEmail: 'support@wizoneit.com',
                customerPhone: '+91-9876543210',
                customerAddress: 'IT Park, Sector 45, Gurgaon, Haryana, India',
                assigneeId: 3, // Admin User
                assigneeName: 'Admin User',
                issueType: 'support',
                createdAt: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString(),
                updatedAt: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString()
            },
            {
                id: 4,
                title: 'Field Installation Work',
                description: 'Install network equipment at customer site in Noida',
                status: 'assigned',
                priority: 'high',
                customerId: 4,
                customerName: 'Delhi Tech Services',
                customerEmail: 'operations@delhitech.com',
                customerPhone: '+91-9876543212',
                customerAddress: 'Sector 18, Noida, Uttar Pradesh, India',
                assigneeId: 1, // Ravi Kumar
                assigneeName: 'Ravi Kumar',
                issueType: 'installation',
                createdAt: new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString(),
                updatedAt: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString()
            },
            {
                id: 5,
                title: 'Customer Support Call',
                description: 'Handle escalated support request for network connectivity issues',
                status: 'in-progress',
                priority: 'medium',
                customerId: 3,
                customerName: 'Tech Solutions Mumbai',
                customerEmail: 'admin@techsolutions.com',
                customerPhone: '+91-9876543211',
                customerAddress: 'Tech Hub, Andheri East, Mumbai, Maharashtra, India',
                assigneeId: 2, // Hussaifa Ali
                assigneeName: 'Hussaifa Ali',
                issueType: 'support',
                createdAt: new Date(Date.now() - 6 * 60 * 60 * 1000).toISOString(),
                updatedAt: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString()
            }
        ];

        const mockTaskUpdates = {
            1: [
                {
                    id: 1,
                    taskId: 1,
                    updateType: 'status_change',
                    oldValue: 'open',
                    newValue: 'pending',
                    note: 'Task assigned and moved to pending status',
                    updatedBy: 'System Admin',
                    createdAt: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 2,
                    taskId: 1,
                    updateType: 'comment',
                    note: 'Initial assessment completed. Planning maintenance window.',
                    updatedBy: 'System Admin',
                    createdAt: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString()
                }
            ],
            2: [
                {
                    id: 3,
                    taskId: 2,
                    updateType: 'status_change',
                    oldValue: 'pending',
                    newValue: 'in-progress',
                    note: 'Started network configuration work',
                    updatedBy: 'Network Engineer',
                    createdAt: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString()
                }
            ],
            3: [
                {
                    id: 4,
                    taskId: 3,
                    updateType: 'task_created',
                    note: 'New support request created by customer',
                    updatedBy: 'System',
                    createdAt: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString()
                }
            ]
        };
        
        const mockStats = {
            totalTasks: 3,
            pendingTasks: 1,
            inProgressTasks: 1,
            completedTasks: 0
        };

        const mockUsers = [
            {
                id: 1,
                username: 'admin',
                email: 'admin@wizone.com',
                firstName: 'Admin',
                lastName: 'User',
                role: 'admin',
                department: 'IT Management',
                phone: '+91-9876543210',
                isActive: true,
                createdAt: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString()
            },
            {
                id: 2,
                username: 'ravi',
                email: 'ravi@wizone.com',
                firstName: 'Ravi',
                lastName: 'Kumar',
                role: 'engineer',
                department: 'Field Engineering',
                phone: '+91-9876543211',
                isActive: true,
                createdAt: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString()
            },
            {
                id: 3,
                username: 'hussaifa',
                email: 'hussaifa@wizone.com',
                firstName: 'Hussaifa',
                lastName: 'Ali',
                role: 'technician',
                department: 'Technical Support',
                phone: '+91-9876543212',
                isActive: true,
                createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
            },
            {
                id: 4,
                username: 'engineer',
                email: 'engineer@wizone.com',
                firstName: 'Field',
                lastName: 'Engineer',
                role: 'engineer',
                department: 'Field Operations',
                phone: '+91-9876543213',
                isActive: true,
                createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString()
            },
            {
                id: 5,
                username: 'support',
                email: 'support@wizone.com',
                firstName: 'Support',
                lastName: 'Team',
                role: 'support',
                department: 'Customer Support',
                phone: '+91-9876543214',
                isActive: true,
                createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString()
            },
            {
                id: 6,
                username: 'demo',
                email: 'demo@wizone.com',
                firstName: 'Demo',
                lastName: 'User',
                role: 'admin',
                department: 'Demo',
                phone: '+91-9876543215',
                isActive: true,
                createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString()
            }
        ];
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Wizone Task Manager Mobile App Initialized');
            
            // Check network status
            updateNetworkStatus();
            
            // Setup event listeners
            setupEventListeners();
            
            // Check if user is already logged in
            const savedUser = localStorage.getItem('wizoneUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showDashboard();
                loadDashboardData();
            }
        });
        
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Network status
            window.addEventListener('online', () => {
                isOnline = true;
                updateNetworkStatus();
                if (currentUser && !offlineMode) {
                    loadDashboardData();
                }
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateNetworkStatus();
            });
        }
        
        function updateNetworkStatus() {
            const banner = document.getElementById('offlineBanner');
            if (!isOnline || offlineMode) {
                banner.classList.add('show');
            } else {
                banner.classList.remove('show');
            }
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            
            if (!username || !password) {
                showErrorMessage('Please enter both username and password');
                return;
            }
            
            console.log('üéØ PRODUCTION DATABASE ONLY - Attempting login for:', username);
            console.log('üîó Target server:', currentApiUrl);
            
            loginBtn.innerHTML = 'üîÑ Connecting to Database...';
            loginBtn.disabled = true;
            errorDiv.style.display = 'none';
            
            console.log('üéØ PRODUCTION LOGIN - Target Database:', API_URLS[0]);
            
            try {
                let loginSuccess = false;
                let userData = null;
                
                // Try each server for REAL database authentication
                for (let i = 0; i < API_URLS.length; i++) {
                    try {
                        const serverUrl = API_URLS[i];
                        console.log(`üîó Testing server ${i + 1}: ${serverUrl}`);
                        showInfoMessage(`üîó Connecting to database server ${i + 1}...`);
                        
                        // Correct authentication endpoint construction
                        const authEndpoint = `${serverUrl}/api/auth/login`;
                        console.log(`ÔøΩ Auth URL: ${authEndpoint}`);
                        
                        const response = await fetch(authEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({
                                username: username,
                                password: password
                            }),
                            timeout: 8000
                        });
                        
                        console.log(`üìä Server ${i + 1} response status:`, response.status);
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('‚úÖ Database Response:', result);
                            
                            // Handle ALL possible database response formats
                            if (result.success && result.user) {
                                userData = result.user;
                                currentApiUrl = serverUrl;
                                loginSuccess = true;
                                showInfoMessage(`‚úÖ Connected to production database!`);
                                break;
                            } else if (result.user) {
                                userData = result.user;
                                currentApiUrl = serverUrl;
                                loginSuccess = true;
                                showInfoMessage(`‚úÖ Database authentication successful!`);
                                break;
                            } else if (result.token || result.id || result.user_id || result.username) {
                                // Handle direct user object response
                                userData = result;
                                currentApiUrl = serverUrl;
                                loginSuccess = true;
                                showInfoMessage(`‚úÖ Database authentication successful!`);
                                break;
                            } else if (result.data && result.data.user) {
                                userData = result.data.user;
                                currentApiUrl = serverUrl;
                                loginSuccess = true;
                                showInfoMessage(`‚úÖ Database authentication successful!`);
                                break;
                            } else if (result.data) {
                                userData = result.data;
                                currentApiUrl = serverUrl;
                                loginSuccess = true;
                                showInfoMessage(`‚úÖ Database authentication successful!`);
                                break;
                            }
                        } else {
                            const errorText = await response.text();
                            console.log(`‚ùå Server ${i + 1} error:`, response.status, errorText);
                        }
                        
                    } catch (error) {
                        console.log(`‚ùå Server ${i + 1} connection failed:`, error.message);
                        showInfoMessage(`‚ùå Server ${i + 1} unreachable, trying next...`);
                        continue;
                    }
                }
                
                if (loginSuccess && userData) {
                    console.log('‚úÖ DATABASE LOGIN SUCCESS');
                    
                    // Create user object based on actual database schema
                    currentUser = {
                        id: userData.id || userData.user_id || userData.userId,
                        username: userData.username || userData.email || username,
                        firstName: userData.firstName || userData.first_name || userData.name?.split(' ')[0] || username,
                        lastName: userData.lastName || userData.last_name || userData.name?.split(' ')[1] || '',
                        email: userData.email || `${username}@wizone.com`,
                        role: userData.role || 'engineer',
                        department: userData.department || 'Field Engineering',
                        isActive: userData.active !== false,
                        token: userData.token || userData.access_token,
                        databaseAuth: true
                    };
                    
                    // Save to localStorage
                    localStorage.setItem('wizoneUser', JSON.stringify(currentUser));
                    
                    showSuccessMessage(`‚úÖ Welcome ${currentUser.firstName}! Connected to production database.`);
                    
                    setTimeout(() => {
                        showDashboard();
                        loadDashboardData();
                        loginBtn.innerHTML = 'üîë Login to Dashboard';
                        loginBtn.disabled = false;
                    }, 1500);
                    
                    return;
                    
                } else {
                    // NO FALLBACKS - Only database authentication allowed
                    console.log('‚ùå DATABASE AUTHENTICATION FAILED');
                    throw new Error('Authentication failed: Invalid credentials or database unavailable');
                }
                
            } catch (error) {
                console.error('‚ùå Login process failed:', error);
                showErrorMessage('‚ùå Login failed: Invalid credentials or server unavailable. Please check your username and password.');
                
                loginBtn.innerHTML = 'üîë Login to Dashboard';
                loginBtn.disabled = false;
            }
            
            console.log('üî• PRODUCTION MODE: Attempting server connection');
            
            // Show connection status
            showInfoMessage('üîç Testing network connectivity...');
            
            // Test basic connectivity first
            try {
                await fetch('https://www.google.com', { 
                    method: 'HEAD', 
                    timeout: 3000,
                    mode: 'no-cors'
                });
                showInfoMessage('‚úÖ Internet connection OK. Testing local servers...');
            } catch (e) {
                showInfoMessage('‚ö†Ô∏è Limited connectivity. Testing local servers...');
            }
            
            // First, try database authentication via API with multiple server fallbacks
            try {
                
                if (isOnline) {
                    console.log('Attempting database login for:', username);
                    
                    let response = null;
                    let apiError = null;
                    
                    // Try each API URL until one works
                    for (let i = 0; i < API_URLS.length; i++) {
                        try {
                            const serverInfo = API_URLS[i].replace('http://', '').replace('/api', '');
                            console.log(`üåê Trying API server ${i + 1}/${API_URLS.length}: ${API_URLS[i]}`);
                            showInfoMessage(`üåê Server ${i + 1}: ${serverInfo}`);
                            
                            // Test health endpoint first
                            console.log(`üè• Testing health endpoint: ${API_URLS[i]}/health`);
                            try {
                                const healthCheck = await fetch(`${API_URLS[i]}/health`, {
                                    method: 'GET',
                                    timeout: 3000
                                });
                                console.log(`üè• Health check response: ${healthCheck.status}`);
                                if (healthCheck.ok) {
                                    showInfoMessage(`‚úÖ Server ${i + 1} responding! Logging in...`);
                                    console.log(`‚úÖ Health check passed for server ${i + 1}`);
                                } else {
                                    console.log(`‚ö†Ô∏è Health check failed for server ${i + 1}: ${healthCheck.status}`);
                                    showInfoMessage(`‚ö†Ô∏è Server ${i + 1} health check failed (${healthCheck.status})`);
                                }
                            } catch (healthError) {
                                console.log(`‚ùå Health check error for server ${i + 1}:`, healthError);
                                showInfoMessage(`‚ùå Server ${i + 1} unreachable: ${healthError.message}`);
                                throw healthError;
                            }
                            
                            console.log(`üîê Attempting login to: ${API_URLS[i]}/auth/login`);
                            console.log(`üìù Login payload:`, { username, password: password ? '***' : 'EMPTY' });
                            
                            response = await fetch(`${API_URLS[i]}/auth/login`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                },
                                body: JSON.stringify({ username, password }),
                                timeout: 8000
                            });
                            
                            console.log(`üîê Login response status: ${response.status}`);
                            
                            if (response.ok) {
                                currentApiUrl = API_URLS[i];
                                apiUrlIndex = i;
                                console.log(`‚úÖ Connected to API server: ${currentApiUrl}`);
                                showSuccessMessage(`Connected to database server ${i + 1}`);
                                break;
                            } else {
                                console.log(`‚ùå Server ${i + 1} responded with ${response.status}`);
                                response = null;
                            }
                        } catch (error) {
                            console.log(`‚ùå Server ${i + 1} connection failed:`, error.message);
                            showInfoMessage(`Server ${i + 1} unavailable, trying next...`);
                            apiError = error;
                            response = null;
                        }
                    }
                    
                    // If no server responded successfully, throw the last error
                    if (!response) {
                        throw apiError || new Error('All API servers unavailable');
                    }
                    
                    if (response.ok) {
                        currentUser = await response.json();
                        console.log('Database login successful:', currentUser);
                        
                        // Save user session
                        localStorage.setItem('wizoneUser', JSON.stringify(currentUser));
                        
                        // Show success and redirect
                        showSuccessMessage(`Welcome ${currentUser.firstName}! Loading your dashboard...`);
                        
                        setTimeout(() => {
                            showDashboard();
                            loadDashboardData();
                        }, 1000);
                        
                        loginBtn.innerHTML = 'üîë Login to Dashboard';
                        loginBtn.disabled = false;
                        return;
                    } else {
                        const errorData = await response.json();
                        console.log('Database login failed:', errorData.message);
                        throw new Error(errorData.message || 'Invalid credentials');
                    }
                }
            } catch (error) {
                console.log('‚ùå DATABASE AUTHENTICATION FAILED:', error.message);
                console.log('üö´ NO FALLBACK AUTHENTICATION - Database connection required');
                
                // NO FALLBACKS - Force database-only authentication
                showErrorMessage(`‚ùå Authentication failed: Cannot connect to production database at ${currentApiUrl}. Please check your credentials and server connection.`);
                
                loginBtn.innerHTML = 'üîë Login to Dashboard';
                loginBtn.disabled = false;
                return;
            }
            
            // REMOVED ALL FALLBACK AUTHENTICATION - DATABASE ONLY
                // Admin users
                { username: 'admin', password: 'admin123', role: 'admin', name: 'Admin User', id: 1 },
                { username: 'admin', password: 'admin', role: 'admin', name: 'Admin User', id: 1 },
                
                // Field engineers (confirmed from database logs - using @123 pattern)
                { username: 'ravi', password: 'ravi@123', role: 'field_engineer', name: 'Ravi Kumar', id: 12 },
                { username: 'Ravi', password: 'ravi@123', role: 'field_engineer', name: 'Ravi Kumar', id: 12 },
                { username: 'rohit', password: 'rohit@123', role: 'field_engineer', name: 'Rohit Singh', id: 11 },
                { username: 'Rohit', password: 'rohit@123', role: 'field_engineer', name: 'Rohit Singh', id: 11 },
                { username: 'huzaifa', password: 'huzaifa@123', role: 'field_engineer', name: 'Huzaifa Ali', id: 10 },
                { username: 'Huzaifa', password: 'huzaifa@123', role: 'field_engineer', name: 'Huzaifa Ali', id: 10 },
                { username: 'sachin', password: 'sachin@123', role: 'field_engineer', name: 'Sachin Garg', id: 9 },
                { username: 'Sachin', password: 'sachin@123', role: 'field_engineer', name: 'Sachin Garg', id: 9 },
                { username: 'vikash', password: 'vikash@123', role: 'field_engineer', name: 'Vikash Kumar', id: 21 },
                { username: 'Vikash', password: 'vikash@123', role: 'field_engineer', name: 'Vikash Kumar', id: 21 },
                
                // Fallback simple passwords (backward compatibility)
                { username: 'ravi', password: 'ravi', role: 'field_engineer', name: 'Ravi Kumar', id: 12 },
                { username: 'rohit', password: 'rohit', role: 'field_engineer', name: 'Rohit Singh', id: 11 },
                { username: 'huzaifa', password: 'huzaifa', role: 'field_engineer', name: 'Huzaifa Ali', id: 10 },
                { username: 'sachin', password: 'sachin', role: 'field_engineer', name: 'Sachin Garg', id: 9 },
                { username: 'vikash', password: 'vikash', role: 'field_engineer', name: 'Vikash Kumar', id: 21 },
                
                // Backend engineers
                { username: 'ashutosh', password: 'ashutosh@123', role: 'backend_engineer', name: 'Ashutosh Kashyap', id: 14 },
                { username: 'fareed', password: 'fareed@123', role: 'backend_engineer', name: 'Fareed Rana', id: 17 }
            ];
            
            const validUser = validCredentials.find(cred => 
                cred.username.toLowerCase() === username.toLowerCase() && cred.password === password
            );
            
            if (validUser) {
                console.log('Fallback login successful for:', validUser.name);
                
                // Valid credentials found - create user session
                currentUser = {
                    id: validUser.id,
                    username: validUser.username,
                    firstName: validUser.name.split(' ')[0],
                    lastName: validUser.name.split(' ')[1] || 'User',
                    email: `${validUser.username}@wizone.com`,
                    role: validUser.role,
                    name: validUser.name
                };
                
                localStorage.setItem('wizoneUser', JSON.stringify(currentUser));
                showSuccessMessage(`Welcome ${validUser.name}! Loading your dashboard...`);
                
                setTimeout(() => {
                    showDashboard();
                    loadDashboardData();
                }, 1000);
                
                loginBtn.innerHTML = 'üîë Login to Dashboard';
                loginBtn.disabled = false;
                return;
            }
            
            // If all authentication methods fail
            console.log('All authentication methods failed');
            showErrorMessage(`Login failed: Invalid username or password. Please contact system administrator for access.`);
            
            loginBtn.innerHTML = 'üîë Login to Dashboard';
            loginBtn.disabled = false;
        }
        
        function showOfflineMode() {
            offlineMode = true;
            currentUser = {
                id: 1,
                username: 'offline',
                firstName: 'Offline',
                lastName: 'User',
                email: 'offline@wizone.com',
                role: 'engineer'
            };
            
            updateNetworkStatus();
            showDashboard();
            loadOfflineData();
        }
        
        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').classList.add('active');
            document.getElementById('userManagementSection').classList.remove('active');
            document.getElementById('profileSection').classList.remove('active');
            document.getElementById('navigation').classList.add('active');
            
            // Update navigation
            updateNavigation('dashboard');
        }

        function showUserManagement() {
            document.getElementById('dashboardSection').classList.remove('active');
            document.getElementById('userManagementSection').classList.add('active');
            document.getElementById('profileSection').classList.remove('active');
            
            // Load users data
            loadUsers();
            
            // Update navigation
            updateNavigation('users');
        }
        
        function showProfile() {
            document.getElementById('dashboardSection').classList.remove('active');
            document.getElementById('userManagementSection').classList.remove('active');
            document.getElementById('profileSection').classList.add('active');
            
            // Update profile info
            if (currentUser) {
                document.getElementById('profileName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                document.getElementById('profileEmail').textContent = currentUser.email;
                document.getElementById('profileAvatar').textContent = currentUser.firstName.charAt(0).toUpperCase();
            }
            
            // Update navigation
            updateNavigation('profile');
        }
        
        function updateNavigation(active) {
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => btn.classList.remove('active'));
            
            if (active === 'dashboard') {
                navBtns[0].classList.add('active');
            } else if (active === 'users') {
                navBtns[1].classList.add('active');
            } else if (active === 'profile') {
                navBtns[2].classList.add('active');
            }
        }
        
        async function loadDashboardData() {
            console.log('üìä Loading dashboard data from production database...');
            
            try {
                // Load tasks first (this will set proper stats)
                await loadTasks();
                
                // Load additional dashboard stats if available
                try {
                    const statsResponse = await fetch(`${currentApiUrl}/api/dashboard/stats`, {
                        headers: currentUser?.token ? {
                            'Authorization': `Bearer ${currentUser.token}`
                        } : {}
                    });
                    
                    if (statsResponse.ok) {
                        const stats = await statsResponse.json();
                        console.log('üìä Dashboard stats from database:', stats);
                        updateStatsDisplay(stats);
                    }
                } catch (statsError) {
                    console.log('üìä Dashboard stats not available, using calculated stats');
                    // Stats already updated in loadTasks
                }
                
            } catch (error) {
                console.error('üìä Dashboard loading failed:', error);
                showErrorMessage('‚ùå Dashboard loading failed: Database connection required');
            }
        }
        
        function loadOfflineData() {
            updateStatsDisplay(mockStats);
            allTasks = mockTasks;
            displayTasks(mockTasks);
            
            // Load users
            allUsers = mockUsers;
            
            // Hide loading
            document.getElementById('loadingTasks').style.display = 'none';
        }
        
        async function loadTasks() {
            const loadingEl = document.getElementById('loadingTasks');
            const containerEl = document.getElementById('tasksContainer');
            
            loadingEl.style.display = 'block';
            containerEl.innerHTML = '';
            
            try {
                if (!isOnline || offlineMode) {
                    throw new Error('Offline mode');
                }
                
                console.log('üìã Loading tasks from production database...');
                
                const userId = currentUser?.id;
                const userRole = currentUser?.role || 'field_engineer';
                const taskParams = `?user_id=${userId}&user_role=${userRole}`;
                
                let response = null;
                
                // Try each server for tasks
                for (let i = 0; i < API_URLS.length; i++) {
                    try {
                        const tasksUrl = `${API_URLS[i]}/api/tasks${taskParams}`;
                        console.log(`üìã Trying: ${tasksUrl}`);
                        
                        response = await fetch(tasksUrl, {
                            headers: currentUser?.token ? {
                                'Authorization': `Bearer ${currentUser.token}`
                            } : {}
                        });
                        
                        if (response.ok) {
                            currentApiUrl = API_URLS[i];
                            console.log(`‚úÖ Tasks loaded from: ${currentApiUrl}`);
                            break;
                        }
                    } catch (error) {
                        console.log(`‚ùå Task server ${i + 1} failed:`, error.message);
                    }
                }
                
                if (response && response.ok) {
                    const tasks = await response.json();
                    console.log('üìã Database tasks loaded:', tasks.length);
                    console.log('üìã Raw tasks data:', tasks);
                    
                    allTasks = Array.isArray(tasks) ? tasks : [];
                    
                    // STRICT FILTERING - Only show tasks assigned to current engineer
                    if (currentUser && currentUser.role !== 'admin') {
                        console.log('üîç Filtering tasks for engineer:', currentUser.username, 'ID:', currentUser.id);
                        
                        userTasks = allTasks.filter(task => {
                            // Check actual database field names for task assignment (from schema.ts)
                            const isAssigned = (
                                // ID-based matching (actual database fields)
                                task.assignedTo === currentUser.id ||
                                task.fieldEngineerId === currentUser.id ||
                                
                                // Name-based matching (actual database fields)
                                task.assignedToName?.toLowerCase() === currentUser.username.toLowerCase() ||
                                task.fieldEngineerName?.toLowerCase() === currentUser.username.toLowerCase() ||
                                task.assignedToName?.toLowerCase() === currentUser.firstName.toLowerCase() ||
                                task.fieldEngineerName?.toLowerCase() === currentUser.firstName.toLowerCase() ||
                                task.assignedToName?.toLowerCase().includes(currentUser.firstName.toLowerCase()) ||
                                task.fieldEngineerName?.toLowerCase().includes(currentUser.firstName.toLowerCase())
                            );
                            
                            if (isAssigned) {
                                console.log('‚úÖ Task assigned to user:', {
                                    taskId: task.id,
                                    title: task.title,
                                    assignedTo: task.assignedTo,
                                    assignedToName: task.assignedToName,
                                    fieldEngineerId: task.fieldEngineerId,
                                    fieldEngineerName: task.fieldEngineerName,
                                    currentUserId: currentUser.id,
                                    currentUsername: currentUser.username,
                                    currentFirstName: currentUser.firstName
                                });
                            }
                            
                            return isAssigned;
                        });
                        
                        console.log(`üìã Filtered ${userTasks.length} tasks for engineer ${currentUser.username}`);
                        displayTasks(userTasks);
                        updateStatsDisplay(calculateStats(userTasks));
                    } else {
                        // Admin sees all tasks
                        console.log('üë§ Admin user - showing all tasks');
                        displayTasks(allTasks);
                        updateStatsDisplay(calculateStats(allTasks));
                    }
                    return;
                }
                
                throw new Error('No database servers available');
                
            } catch (error) {
                console.error('üìã Task loading failed:', error);
                
                // NO FALLBACKS - Must connect to database
                allTasks = [];
                userTasks = [];
                displayTasks([]);
                updateStatsDisplay({ totalTasks: 0, pendingTasks: 0, inProgressTasks: 0, completedTasks: 0 });
                
                showErrorMessage('‚ùå Cannot load tasks: Database connection required. Please check your internet connection.');
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        async function loadUsers() {
            const loadingEl = document.getElementById('loadingUsers');
            const containerEl = document.getElementById('usersContainer');
            
            loadingEl.style.display = 'block';
            containerEl.innerHTML = '';
            
            try {
                if (!isOnline || offlineMode) {
                    throw new Error('Offline mode');
                }
                
                console.log('üë• Loading users from production database...');
                
                let response = null;
                
                // Try each server for users
                for (let i = 0; i < API_URLS.length; i++) {
                    try {
                        const usersUrl = `${API_URLS[i]}/api/users`;
                        console.log(`üë• Trying: ${usersUrl}`);
                        
                        response = await fetch(usersUrl, {
                            headers: currentUser?.token ? {
                                'Authorization': `Bearer ${currentUser.token}`
                            } : {}
                        });
                        
                        if (response.ok) {
                            console.log(`‚úÖ Users loaded from: ${API_URLS[i]}`);
                            break;
                        }
                    } catch (error) {
                        console.log(`‚ùå User server ${i + 1} failed:`, error.message);
                    }
                }
                
                if (response && response.ok) {
                    const users = await response.json();
                    console.log('üë• Database users loaded:', users.length);
                    
                    if (users && users.length > 0) {
                        allUsers = users;
                        displayUsers(users);
                        return;
                    }
                }
                
                throw new Error('No users available from database');
                
            } catch (error) {
                console.error('üë• User loading failed:', error);
                
                // NO FALLBACKS - Must connect to database
                allUsers = [];
                displayUsers([]);
                
                showErrorMessage('‚ùå Cannot load users: Database connection required. Please check your internet connection.');
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        function displayUsers(users) {
            const container = document.getElementById('usersContainer');
            
            if (!users || users.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No users found</p>';
                return;
            }
            
            container.innerHTML = users.map(user => `
                <div class="user-card">
                    <div class="user-header">
                        <div class="user-name">${user.firstName} ${user.lastName}</div>
                        <div class="user-role">${user.role}</div>
                    </div>
                    <div class="user-info">
                        <div>üìß ${user.email}</div>
                        <div>üì± ${user.phone || 'N/A'}</div>
                        <div>üè¢ ${user.department}</div>
                        <div>üìÖ Joined: ${formatDate(user.createdAt)}</div>
                        <div>Status: ${user.isActive ? '‚úÖ Active' : '‚ùå Inactive'}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function displayTasks(tasks) {
            const container = document.getElementById('tasksContainer');
            
            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No tasks available</p>';
                return;
            }
            
            container.innerHTML = tasks.map(task => `
                <div class="task-card" onclick="openTaskDetails(${task.id})">
                    <div class="task-header">
                        <div class="task-id">#${task.id}</div>
                        <div class="task-status status-${task.status.replace(/[^a-zA-Z0-9]/g, '-')}">${task.status}</div>
                    </div>
                    <div class="task-title">${task.title}</div>
                    <div class="task-description">${task.description}</div>
                    <div style="margin-top: 10px; font-size: 12px; color: #888;">
                        üìÖ ${formatDate(task.createdAt)} | üè¢ ${task.customerName || 'Unknown Customer'}
                    </div>
                </div>
            `).join('');
        }
        
        async function openTaskDetails(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) {
                showErrorMessage('Task not found');
                return;
            }

            // Load task updates
            let taskUpdates = [];
            try {
                if (!offlineMode && isOnline) {
                    const response = await fetch(`${API_BASE_URL}/tasks/${taskId}/updates`);
                    if (response.ok) {
                        taskUpdates = await response.json();
                    }
                } else {
                    taskUpdates = mockTaskUpdates[taskId] || [];
                }
            } catch (error) {
                console.error('Error loading task updates:', error);
                taskUpdates = mockTaskUpdates[taskId] || [];
            }

            // Show task details modal
            showTaskModal(task, taskUpdates);
        }

        function showTaskModal(task, updates) {
            const modal = document.getElementById('taskModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');

            modalTitle.textContent = `Task #${task.id}: ${task.title}`;

            modalContent.innerHTML = `
                <div class="detail-section">
                    <h4>üìã Task Information</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Status:</div>
                            <div class="detail-value">
                                <span class="task-status status-${task.status.replace(/[^a-zA-Z0-9]/g, '-')}">${task.status}</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Priority:</div>
                            <div class="detail-value">${task.priority || 'Medium'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Assigned to:</div>
                            <div class="detail-value">${task.assigneeName || 'Unassigned'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Issue Type:</div>
                            <div class="detail-value">${task.issueType || 'General'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Created:</div>
                            <div class="detail-value">${formatFullDate(task.createdAt)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Last Updated:</div>
                            <div class="detail-value">${formatFullDate(task.updatedAt)}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h4>üìù Description</h4>
                    <p style="color: #333; line-height: 1.5; margin: 10px 0;">${task.description}</p>
                </div>

                <div class="detail-section">
                    <h4>üè¢ Customer Information</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Customer:</div>
                            <div class="detail-value">${task.customerName}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Email:</div>
                            <div class="detail-value">${task.customerEmail}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Phone:</div>
                            <div class="detail-value">${task.customerPhone || 'Not provided'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Address:</div>
                            <div class="detail-value">${task.customerAddress || 'Not provided'}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h4>üìú Task History (${updates.length} updates)</h4>
                    <div id="taskHistory">
                        ${updates.length > 0 ? 
                            updates.map(update => `
                                <div class="history-item">
                                    <div class="history-header">
                                        <div class="history-type">${update.updateType.replace('_', ' ')}</div>
                                        <div class="history-date">${formatFullDate(update.createdAt)}</div>
                                    </div>
                                    <div class="history-note">${update.note}</div>
                                    <div style="font-size: 12px; color: #888; margin-top: 5px;">By: ${update.updatedBy}</div>
                                </div>
                            `).join('') :
                            '<p style="color: #666; text-align: center; padding: 20px;">No updates yet</p>'
                        }
                    </div>
                </div>

                <div class="status-update-section">
                    <h4 style="color: #2c5aa0; margin-bottom: 15px;">üîÑ Update Task Status</h4>
                    
                    <div class="form-group">
                        <label for="newStatus">New Status:</label>
                        <select id="newStatus" class="form-control">
                            <option value="open" ${task.status === 'open' ? 'selected' : ''}>Open</option>
                            <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="in-progress" ${task.status === 'in-progress' || task.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                            <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                            <option value="resolved" ${task.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="updateNote">Update Note:</label>
                        <input type="text" id="updateNote" placeholder="Add a note about this update..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <button class="btn btn-success btn-small" onclick="updateTaskStatus(${task.id})">
                        ‚úÖ Update Status
                    </button>
                    
                    <button class="btn btn-secondary btn-small" onclick="closeTaskModal()">
                        ‚ùå Cancel
                    </button>
                </div>
            `;

            modal.classList.add('active');
        }

        async function updateTaskStatus(taskId) {
            const newStatus = document.getElementById('newStatus').value;
            const updateNote = document.getElementById('updateNote').value;
            
            if (!updateNote.trim()) {
                showErrorMessage('Please add a note for this update');
                return;
            }

            try {
                const task = allTasks.find(t => t.id === taskId);
                if (!task) {
                    throw new Error('Task not found');
                }

                const updateData = {
                    status: newStatus,
                    note: updateNote,
                    userId: currentUser?.id
                };

                let updateSuccess = false;

                // MANDATORY: Update task in production database
                console.log(`üìù Sending task update to production database: Task ${taskId} -> ${newStatus}`);
                
                const updatePayload = {
                    taskId: taskId,
                    status: newStatus,
                    note: updateNote,
                    updatedBy: currentUser?.id,
                    engineerName: `${currentUser?.firstName} ${currentUser?.lastName}`,
                    timestamp: new Date().toISOString()
                };
                
                try {
                    const response = await fetch(`${currentApiUrl}/api/tasks/${taskId}/update`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': currentUser?.token ? `Bearer ${currentUser.token}` : undefined
                        },
                        body: JSON.stringify(updatePayload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('‚úÖ Task status updated in production database:', result);
                        updateSuccess = true;
                        
                        // Update local task data
                        const taskIndex = allTasks.findIndex(t => t.id === taskId);
                        if (taskIndex !== -1) {
                            allTasks[taskIndex].status = newStatus;
                            allTasks[taskIndex].updatedAt = new Date().toISOString();
                        }
                        
                        // Update userTasks if filtering
                        const userTaskIndex = userTasks.findIndex(t => t.id === taskId);
                        if (userTaskIndex !== -1) {
                            userTasks[userTaskIndex].status = newStatus;
                            userTasks[userTaskIndex].updatedAt = new Date().toISOString();
                        }
                        
                    } else {
                        const errorText = await response.text();
                        console.error('‚ùå Database update failed:', response.status, errorText);
                        throw new Error(`Database update failed: ${response.status}`);
                    }
                } catch (apiError) {
                    console.error('‚ùå Failed to update task in database:', apiError.message);
                    throw new Error('Failed to update task in production database. Please check your connection.');
                }
                
                if (updateSuccess) {
                    showSuccessMessage(`‚úÖ Task #${taskId} updated to "${newStatus}" successfully! Update logged in production database.`);
                    
                    // Refresh task display with updated data
                    if (currentUser && currentUser.role !== 'admin') {
                        displayTasks(userTasks);
                        updateStatsDisplay(calculateStats(userTasks));
                    } else {
                        displayTasks(allTasks);
                        updateStatsDisplay(calculateStats(allTasks));
                    }
                    
                    closeTaskModal();
                } else {
                    throw new Error('Task update failed - no database connection');
                }

            } catch (error) {
                console.error('Error updating task:', error);
                showErrorMessage('Failed to update task status: ' + error.message);
            }
        }

        function calculateStats(tasks) {
            return {
                totalTasks: tasks.length,
                pendingTasks: tasks.filter(t => t.status === 'pending').length,
                inProgressTasks: tasks.filter(t => t.status === 'in-progress' || t.status === 'in_progress').length,
                completedTasks: tasks.filter(t => t.status === 'completed').length
            };
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
        }
        
        function updateStatsDisplay(stats) {
            document.getElementById('totalTasks').textContent = stats.totalTasks || 0;
            document.getElementById('pendingTasks').textContent = stats.pendingTasks || 0;
            document.getElementById('inProgressTasks').textContent = stats.inProgressTasks || 0;
            document.getElementById('completedTasks').textContent = stats.completedTasks || 0;
        }
        
        function refreshTasks() {
            if (currentUser) {
                loadTasks();
            }
        }

        function refreshUsers() {
            if (currentUser) {
                loadUsers();
            }
        }
        
        function logout() {
            currentUser = null;
            offlineMode = false;
            localStorage.removeItem('wizoneUser');
            
            // Reset UI
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboardSection').classList.remove('active');
            document.getElementById('userManagementSection').classList.remove('active');
            document.getElementById('profileSection').classList.remove('active');
            document.getElementById('navigation').classList.remove('active');
            
            // Clear form
            document.getElementById('loginForm').reset();
            document.getElementById('errorMessage').style.display = 'none';
            
            // Close any open modals
            closeTaskModal();
            
            // Update network status
            updateNetworkStatus();
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            
            if (diffHours < 1) {
                return 'Just now';
            } else if (diffHours < 24) {
                return `${diffHours}h ago`;
            } else {
                const diffDays = Math.floor(diffHours / 24);
                return `${diffDays}d ago`;
            }
        }

        function formatFullDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function showErrorMessage(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        function showInfoMessage(message) {
            // Show info message in error div temporarily  
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.backgroundColor = '#d1ecf1';
            errorDiv.style.color = '#0c5460';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
                errorDiv.style.backgroundColor = '#f8d7da';
                errorDiv.style.color = '#721c24';
            }, 2000);
        }
        
        function showSuccessMessage(message) {
            // Create and show success message
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv && errorDiv.parentNode) {
                errorDiv.parentNode.insertBefore(successDiv, errorDiv);
                
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.remove();
                    }
                }, 3000);
            }
        }
        
        console.log('Wizone Task Manager Enhanced Mobile Interface Ready');
    </script>
</body>
</html>