<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wizone Field Engineer</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; overflow: hidden; }
        
        .loading-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; text-align: center;
        }
        
        .wizone-logo {
            width: 80px; height: 80px; background: white; color: #667eea;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 32px; font-weight: bold; margin-bottom: 20px;
        }
        
        .loading-spinner {
            width: 50px; height: 50px; border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white; border-radius: 50%; animation: spin 1s linear infinite;
            margin: 20px 0;
        }
        
        .status-text { font-size: 18px; margin: 10px 0; animation: pulse 2s infinite; }
        .server-url { font-size: 14px; opacity: 0.8; margin-top: 10px; }
        
        .error-screen {
            display: none; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; background: #f44336; color: white; text-align: center; padding: 20px;
        }
        
        .error-content { max-width: 400px; }
        .error-title { font-size: 24px; margin-bottom: 15px; }
        .error-message { font-size: 16px; margin-bottom: 25px; line-height: 1.5; }
        
        .retry-button {
            background: white; color: #f44336; border: none; padding: 12px 24px;
            border-radius: 8px; font-size: 14px; cursor: pointer; transition: background 0.2s;
        }
        .retry-button:hover { background: #f0f0f0; }
        
        #webview { width: 100%; height: 100vh; border: none; display: none; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .connection-info {
            background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;
            margin: 20px; font-size: 14px; max-width: 350px;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading-screen">
        <div class="wizone-logo">W</div>
        <div class="loading-spinner"></div>
        <div id="status" class="status-text">Connecting to Wizone Server...</div>
        <div id="server-url" class="server-url">http://103.122.85.61:4000</div>
        <div class="connection-info">
            <strong>ðŸ“± Mobile APK</strong><br>
            Production Server Connection<br>
            Database: 103.122.85.61:9095/WIZONEIT_SUPPORT
        </div>
    </div>
    
    <div id="error" class="error-screen">
        <div class="error-content">
            <div class="error-title">Connection Failed</div>
            <div id="error-message" class="error-message">Unable to connect to Wizone server. Please check your internet connection.</div>
            <button class="retry-button" onclick="retryConnection()">Retry Connection</button>
        </div>
    </div>
    
    <iframe id="webview" src="about:blank"></iframe>

    <script>
        // PRODUCTION SERVER - YOUR DATABASE CONFIGURATION
        const PRODUCTION_SERVER = 'http://103.122.85.61:4000';
        const FALLBACK_SERVERS = [
            'http://103.122.85.61:4000',
            'https://103.122.85.61:4000'
        ];

        let currentServer = null;
        let connectionAttempts = 0;
        const maxAttempts = 5;

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log('ðŸ“± Mobile APK:', message);
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'flex';
        }

        function retryConnection() {
            document.getElementById('error').style.display = 'none';
            document.getElementById('loading').style.display = 'flex';
            connectionAttempts = 0;
            connectToServer();
        }

        async function testConnection(serverUrl) {
            try {
                updateStatus(`Testing ${serverUrl}...`);
                console.log(`ðŸ” Testing connection: ${serverUrl}`);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                // Multiple connection attempts
                let response;
                
                // Method 1: Try direct connection
                try {
                    response = await fetch(`${serverUrl}/`, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache',
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    if (response.ok || response.status === 200) {
                        console.log(`âœ… Direct connection successful: ${serverUrl}`);
                        return true;
                    }
                } catch (corsError) {
                    console.log(`âš ï¸ CORS error, trying alternative methods...`);
                }
                
                // Method 2: Try health endpoint
                try {
                    response = await fetch(`${serverUrl}/api/health`, {
                        method: 'GET',
                        mode: 'no-cors',
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    if (response.status === 0 || response.ok) {
                        console.log(`âœ… Health endpoint accessible: ${serverUrl}`);
                        return true;
                    }
                } catch (healthError) {
                    console.log(`âš ï¸ Health endpoint failed`);
                }
                
                // Method 3: Image loading fallback
                try {
                    const testImage = new Image();
                    return new Promise((resolve) => {
                        const timeout = setTimeout(() => {
                            console.log(`âš ï¸ Image test timeout, assuming connection works`);
                            resolve(true);
                        }, 5000);
                        
                        testImage.onload = () => {
                            clearTimeout(timeout);
                            console.log(`âœ… Image fallback successful`);
                            resolve(true);
                        };
                        
                        testImage.onerror = () => {
                            clearTimeout(timeout);
                            console.log(`âš ï¸ Image fallback failed, but proceeding`);
                            resolve(true); // Still proceed
                        };
                        
                        testImage.src = `${serverUrl}/favicon.ico?t=${Date.now()}`;
                    });
                } catch (imageError) {
                    console.log(`âš ï¸ Image fallback error, proceeding anyway`);
                    return true;
                }
                
            } catch (error) {
                console.log(`âŒ Connection test failed: ${error.message}`);
                return false;
            }
        }

        async function connectToServer() {
            connectionAttempts++;
            console.log(`ðŸš€ Connection attempt ${connectionAttempts}/${maxAttempts}`);
            
            updateStatus(`Connecting to production server... (${connectionAttempts}/${maxAttempts})`);
            
            // Try all servers
            for (const serverUrl of FALLBACK_SERVERS) {
                console.log(`ðŸ” Trying server: ${serverUrl}`);
                
                if (await testConnection(serverUrl)) {
                    currentServer = serverUrl;
                    console.log(`âœ… Connected to: ${currentServer}`);
                    loadApplication();
                    return;
                }
                
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // If all servers failed
            if (connectionAttempts < maxAttempts) {
                console.log(`âš ï¸ All servers failed, retrying in 3 seconds...`);
                setTimeout(() => connectToServer(), 3000);
            } else {
                console.log(`âŒ All connection attempts failed`);
                showError(
                    `Could not connect to Wizone server after ${maxAttempts} attempts.\n\n` +
                    `Server: ${PRODUCTION_SERVER}\n` +
                    `Please check:\n` +
                    `â€¢ Internet connection\n` +
                    `â€¢ Server availability\n` +
                    `â€¢ Mobile data/WiFi settings`
                );
            }
        }

        function loadApplication() {
            updateStatus('Loading Wizone Task Manager...');
            console.log(`ðŸš€ Loading application from: ${currentServer}`);
            
            const webview = document.getElementById('webview');
            const loading = document.getElementById('loading');

            webview.onload = function() {
                console.log('âœ… Wizone application loaded successfully');
                loading.style.display = 'none';
                webview.style.display = 'block';
                
                // Mobile APK ready message
                console.log('ðŸ“± Mobile APK ready for login with admin/admin123');
                
                // Inject mobile APK identification
                setTimeout(() => {
                    try {
                        const mobileInfo = {
                            isMobileAPK: true,
                            serverUrl: currentServer,
                            databaseInfo: '103.122.85.61:9095/WIZONEIT_SUPPORT',
                            buildTime: new Date().toISOString(),
                            apkVersion: '1.0'
                        };
                        
                        webview.contentWindow.postMessage({
                            type: 'MOBILE_APK_READY',
                            info: mobileInfo
                        }, '*');
                        
                        console.log('ðŸ“± Mobile APK info injected:', mobileInfo);
                    } catch (e) {
                        console.log('Note: Could not inject mobile info (cross-origin)');
                    }
                }, 2000);
            };

            webview.onerror = function(error) {
                console.log('âŒ Application load failed:', error);
                showError('Failed to load Wizone application. Please check server status.');
            };

            // Start loading the application
            webview.src = currentServer;
        }

        // Start connection on page load
        window.onload = function() {
            console.log('ðŸ“± Wizone Mobile APK Starting...');
            console.log(`ðŸŽ¯ Target server: ${PRODUCTION_SERVER}`);
            console.log(`ðŸ—„ï¸ Database: 103.122.85.61:9095/WIZONEIT_SUPPORT`);
            console.log(`ðŸ”‘ Login: admin/admin123 or field engineers`);
            
            // Start connection immediately
            setTimeout(() => connectToServer(), 1000);
        };

        // Handle back button and prevent leaving webview
        window.addEventListener('beforeunload', function(e) {
            e.preventDefault();
            return '';
        });

        // Handle Android back button
        document.addEventListener('backbutton', function(e) {
            e.preventDefault();
            // Could implement navigation within webview
        }, false);

        // Service worker registration for offline support
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(function(registration) {
                console.log('ðŸ“± Service Worker registered');
            }).catch(function(error) {
                console.log('Service Worker registration failed');
            });
        }
    </script>
</body>
</html>